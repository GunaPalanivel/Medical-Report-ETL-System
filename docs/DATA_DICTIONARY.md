# Data Dictionary & Workflow

This document explains the two critical data files generated by the ETL pipeline: `patient_metadata.json` and `id_map.json`.

## 1. ID Mapping (`data/id_map.json`)

**Purpose**: Maintains a secure link between original filenames and anonymized UUIDs.

**Workflow**:
1. When a PDF (e.g., `John_Doe_Report.pdf`) is processed, the system checks this file.
2. **If valid**: Returns the existing UUID (e.g., `550e8400-e29b...`).
3. **If new**: Generates a random UUIDv4, saves the pair, and returns the new UUID.

**Structure**:
```json
{
    "patient_10785.pdf": "ed7d1f9a-1234-5678-9abc-def012345678",
    "patient_14392.pdf": "a1b2c3d4-e5f6-7890-1234-56789abcdef0"
}
```

> **Security Warning**: This file is the "key" to re-identify patients. **NEVER** share this file publicly or commit it to version control.

---

## 2. Patient Metadata (`data/patient_metadata.json`)

**Purpose**: Contains structured clinical data extracted from the reports, linked ONLY by the anonymized UUID.

**Workflow**:
1. **OCR**: Text is extracted from the PDF.
2. **Extraction**: Regex patterns find specific fields (Usage: `src/features/metadata/extractors/`).
3. **Validation**: Values are checked against logical ranges (e.g., gestational age 0-43 weeks).
4. **Aggregation**: All successful extractions are compiled into this list.

**Structure**:
```json
[
    {
        "patient_id": "ed7d1f9a-1234-5678-9abc-def012345678",
        "gestational_age": "28 weeks",
        "age": 34,
        "BMI": 24.5,
        "findings": ["Normal fetal anatomy"],
        "demographic_age": 34,              // Alias for backward compatibility
        "examination_findings": ["Normal..."] // Alias for backward compatibility
    }
]
```

## How It All Connects

1. **Researcher** receives:
   - `data/anonymized_reports/` (PDFs named `ed7d1f9a...pdf`)
   - `data/patient_metadata.json`

2. **Researcher** analysis:
   - "Find all patients with BMI > 30" â†’ Query `patient_metadata.json`.
   - Result: List of UUIDs.
   - Action: Open corresponding PDFs in `anonymized_reports/`.

3. **Hospital Admin** (Authorized):
   - Needs to find original report for UUID `ed7d1f9a...`.
   - Consults `data/id_map.json` (secured offline).
   - result: "Ah, that's `patient_10785.pdf`".
